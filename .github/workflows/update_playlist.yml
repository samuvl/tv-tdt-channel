name: ğŸ”„ Actualizar Playlist IPTV

on:
  # Solo ejecuciÃ³n manual desde GitHub Actions
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: ğŸ” Verificar archivos necesarios
        run: |
          if [ ! -f "build_playlist.py" ]; then
            echo "âŒ ERROR: build_playlist.py no encontrado"
            exit 1
          fi
          if [ ! -f "2-channels_list.txt" ]; then
            echo "âŒ ERROR: 2-channels_list.txt no encontrado"
            exit 1
          fi
          echo "âœ… Archivos necesarios encontrados"
      
      - name: ğŸ¬ Generar playlist actualizada
        id: generate
        run: |
          echo "ğŸš€ Ejecutando build_playlist.py..."
          python3 build_playlist.py
          
          # Verificar que se generÃ³ el archivo
          if [ -f "lista_channels.m3u" ]; then
            CHANNEL_COUNT=$(grep -c "^http" lista_channels.m3u || echo "0")
            echo "âœ… Playlist generada con $CHANNEL_COUNT canales"
            echo "channel_count=$CHANNEL_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERROR: No se pudo generar lista_channels.m3u"
            exit 1
          fi
      
      - name: ğŸ“Š Verificar cambios
        id: check_changes
        run: |
          git diff --quiet lista_channels.m3u || echo "changed=true" >> $GITHUB_OUTPUT
          
          if git diff --quiet lista_channels.m3u; then
            echo "â„¹ï¸ No hay cambios en la playlist"
          else
            echo "ğŸ”„ Cambios detectados en la playlist"
            git diff --stat lista_channels.m3u
          fi
      
      - name: ğŸ“ Commit y Push cambios
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # AÃ±adir archivos generados
          git add lista_channels.m3u 3.1-debug_matching.txt
          
          # Crear commit con informaciÃ³n detallada
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          CHANNEL_COUNT="${{ steps.generate.outputs.channel_count }}"
          
          git commit -m "ğŸ”„ Actualizar playlist IPTV

- Timestamp: $TIMESTAMP
- Canales: $CHANNEL_COUNT
- ActualizaciÃ³n manual ejecutada desde GitHub Actions"
          
          git push
          
          echo "âœ… Cambios publicados en GitHub"
      
      - name: ğŸ“„ Mostrar contenido generado
        run: |
          echo "================================================"
          echo "ğŸ“º CONTENIDO DE LA PLAYLIST GENERADA"
          echo "================================================"
          echo ""
          echo "Primeras 10 lÃ­neas:"
          head -20 lista_channels.m3u
          echo ""
          echo "================================================"
      
      - name: âœ… Resumen de ejecuciÃ³n
        if: always()
        run: |
          echo "================================================"
          echo "ğŸ“Š RESUMEN DE ACTUALIZACIÃ“N"
          echo "================================================"
          echo "ğŸ• Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“º Canales: ${{ steps.generate.outputs.channel_count }}"
          echo "ğŸ”„ Cambios: ${{ steps.check_changes.outputs.changed == 'true' && 'SÃ' || 'NO' }}"
          echo "================================================"
      
      - name: ğŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playlist-generada
          path: |
            lista_channels.m3u
            3.1-debug_matching.txt
          retention-days: 7
